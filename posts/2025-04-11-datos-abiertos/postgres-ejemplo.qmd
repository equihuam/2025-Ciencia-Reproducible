## Preparar Linux y PostgreSQL en tu m√°quina Windows

### WSL
Ahora Windows incluye la opci√≥n de habilitar una versi√≥n de linux virtual que convive con el ambiente Windows, la caracter√≠stica que denomina [*Windows Subsystem Linux* (**WSL**)](https://learn.microsoft.com/es-mx/windows/wsl/). Hay que habilitarlo desde el panel de control como *caracter√≠sticas de Windows* como se ilustra en la @fig-wsl, o mediante comandos desde una ventana de **Powershell** (ü™ü + X; y luego I).


```bash
wsl --install
wsl --version
wsl --install -d ubuntu
```
\ 

Habr√° ahora un √≠cono con el ping√ºino de Linux en tu equipo, que es un enlace a una ventana de terminal directamente asociada con **WSL**. M√°s adelante ser√° una forma de acceso conveniente, pero por lo pronto puedes seguir con la que ya tienes de **Powershell**.

### PostgreSQL

Una vez activado **WSL**, tendr√°s, en este ejemplo, un *linux Ubuntu* en marcha. Ahora puedes instalar _PostgreSQL_ en esa m√°quina virtual. Lo primero es acceder a _linux_ mediante una consola de sistema. Bastar√° con que escribas `wsl` en **Powershell**. Puede ser la misma ventana que usaste para instalar todo, si todav√≠a la tienes abierta, o usar el nuevo √≠cono del ping√ºino. Ahora, escribe las siguientes instrucciones en _linux_. B√°sicamente le estas diciendo que entre en modo de _superusuario_ (`sudo`) y que vaya al servicio general de almacenamiento de aplicaciones (`apt-get`) y conseguir lo necesario para instalar _PostgreSQL_ en la versi√≥n que incluye extensiones y adiciones comunes al _PostgreSQL_ b√°sico.


``` bash
sudo apt-get install postgresql postgresql-contrib
```

La instalaci√≥n inicial de *PostgreSQL* utiliza como usuario de arranque a `postgres`. Es necesario darle un *password* para lograr que *PostgreSQL* nos de acceso. El siguiente comando lo hace. Te generar√° una l√≠nea en la que te pide ingreses la nueva clave que quieras darle al usuario `postgres`. Escribiras pero no ver√°s lo que escribes, por seguiridad obviamente. Al terminar aprieta la tecla **enter/intro/&#9166;**

``` bash
sudo passwd postgres
```

Ahora, desde la misma terminal, tenemos que arrancar a _posgtreSQL_  como un servico activo en el equipo. Esto lo mantendr√° en operaci√≥n hasta que reinicies la m√°quina, en cuyo caso deber√°s reiniciar el servicio.
La instrucci√≥n para hacer esta operaci√≥n es la siguiente.


``` bash
 sudo service postgresql start
```

Esta mismal√≠nea te sirve para detener el servico (stop en lugar de start), reiniciarlo (restart) o para averiguar si est√° activo (status).

Conviene generar un usuario de tu preferencia para interactuar con _PostgreSQL_, evitando dejar como vulnerabilidad la interacci√≥n atrav√©s del usuario com√∫n `postgres`. Para crear ese nuevo usuario usa el siguiente comando.

``` bash
sudo -u postgres psql

psql=# alter user <username> with encrypted password '<password>';
grant all privileges on database <dbname> to <username> ; 
```

Para iniciar tu interacci√≥n con *PostgreSQL* incialmente necesitar√° entrar a la interfaz del sistema con el siguiente comando. Puede ser que te presente alguna advertencia, pero por lo pronto no le hagas caso.

``` bash
sudo -u postgres createuser <username>
```

Para seguir con el ejercicio necesitamos crear una base de datos nueva. Eneste caso usaremos datos de ejemplo. Veamos la base de datos de los pasajeros del Titanic en su tr√°gico viaje inaugural. Lo primero es preparar a _PostgreSQL_ para alojarla.


``` bash
sudo -u postgres createdb titanic
```

Ahora vamos por la base de datos. En _linux_ existe para este fin el comando `wget`. Conviene preparar un directorio para poner estos datos de ejemplo. Un lugar posible podr√≠a ser dentro de tu directorio
**home**, (asocido al s√≠mbolo **) quiz√°s en _db-ejemplos_. Hay que usra `wget` con la opci√≥n **-P** seguida de la ruta deeada para almaenar el xontenido de la URL. Si los directorios involucrados existen, los usa, si no, los crea.


``` bash
wget https://raw.githubusercontent.com/neondatabase/postgres-sample-dbs/main/titanic.sql -P ~/db-ejemplos
```

Ahora hay que cargar los datos en la base de datos `titanic`. El comando para esto es


``` bash
psql -d titanic -f ~/db-ejemplos/titanic.sql
```

Si por falta de derechos de acceso en tu linux, falla algo de lo anterior, esta es la manera de darle todos los derechos ak usuario. No siempre una buena idea dezde el punto de vista de la seguridad. Lo primero es entrar a la consola de _PostgreSQL_ como un usuario administrativo, es decir `postgres`, por ejemplo. Nota el cambio en el encabezado de l√≠nea en tu terminal

``` bash
sudo -u postgres psql
```

Ahora ya estas dentro de _PostgreSQL_ los comandos en su lenguaje, _SQL_, son los siguientes. Nota tambi√©n que cada comando es terminado con ";", si no lo incluyes el interprete de _SQL_ considera que no has terminado de construir la instrucci√≥n y por tanto no la procesa.

``` sql
alter user <username> with encrypted password '<password>';
grant all privileges on database <dbname> to <username> ; 
```

Una vez que todo ha sido configurado podr√°s tener acceso a PostgreSQL y hacer operaciones de todo tipo. A continuaci√≥n un ejemplo muy sencillo con la bae de datos de ejemplo "titanic".

```{r}
pacman::p_load(RPostgres, keyring)


tryCatch({
  drv <- Postgres()
  print("Connecting to Database‚Ä¶")
  connec <- dbConnect(drv, 
                      dbname   = "titanic",
                      host     = Sys.getenv("psql_eq_ip"), 
                      port     = Sys.getenv("psql_eq_port"),
                      user     = key_list("psql-eq")[1,2],
                      password = key_get(service = "psql-eq", 
                                         username = key_list("psql-eq")[1,2]))
  
  print("Database Connected!")
},
error=function(cond) {
  print(cond)
  print("Unable to connect to Database.")
})

df <- dbGetQuery(connec, "SELECT name, hometown FROM passenger;")

head(df)

dbDisconnect(connec)

```

```{r}
df[grepl("sanc", df$name),]
```

