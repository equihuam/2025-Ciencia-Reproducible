---
title: "Datos abiertos"
editor_options: 
  chunk_output_type: console
---


```{r}
pacman::p_load(httr2, jsonlite, tidyverse)

req <- request("https://api.datos.gob.mx/v1/api-catalog?pageSize=8000")
resp <- req_perform(req)

dat_1 <- fromJSON(resp_body_string(resp))
dat_1_df <- dat_1$results

for (i in 1:length(dat_1_df$variables))
{
  dat_1_df$variables[i] <- paste(dat_1_df$variables[[i]], collapse = ",")
}

dat_1_df$variables <- unlist(dat_1_df$variables)

```


```{r}
respuesta_2 <- httr::GET("https://api.datos.gob.mx/v1/condiciones-atmosfericas?pageSize=10000&cityid=MXVZ0111&page=1")

dat_2 <- fromJSON(prettify(respuesta_2))


dat_2_df <- as_tibble(dat_2$results)

max(dat_2_df$`date-insert`)


```


## Ozono

```{r}
url <- "https://api.datos.gob.mx/v2/sinaica?pageSize=8000&parametro=O3&estacionesid=259&page=1"

respuesta <- GET(url)

dat_O3 <- fromJSON(prettify(respuesta))

dat_O3_df <- as_tibble(dat_O3$results)


```


```{r}

url <- "https://smn.conagua.gob.mx/tools/RESOURCES/Normales_Climatologicas/Diarios/ver/dia30393.txt"

dat_meteo_meta <- readLines(url, n = 25)

# datos de la estación
estacion <- tibble(est = unlist(dat_meteo_meta[11:19]))

estacion <- estacion |> 
  mutate(var = str_extract(est, "(.*)(?=\\s:)"),
         val = str_extract(est, "(?<=\\s:)(.*)"),
         var = str_trim(var),
         val = str_trim(val), .keep = "unused" ) 

nombres <- estacion$var

estacion <- as_tibble(t(estacion[, 2]))
names(estacion) <- nombres

# variables meteorologicas
variables <- str_split(readLines(url, n = 24)[24], "\t")[[1]][c(1,3:6)]

# datos meteorológicos
dat_meteo <- read.csv(url, skip = 25, sep = "\t", header = F)
names(dat_meteo) <- variables

dat_meteo |> 
  mutate(idEstacion = estacion$ESTACIÓN)

```

